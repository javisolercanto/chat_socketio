<!DOCTYPE HTML>

<html>

<head>
   <script src="socket.io.js"></script>
</head>

<body>

   <style>
      .container-chat {
         background-color: #F6F6F6;
         padding: 40px;
         height: 300px;
         width: 400px;
         overflow: scroll;
      }

      .container-message {
         display: block;
         width: auto;
         height: fit-content;
         clear: both;
         margin: 5px;
      }

      .message {
         width: 150px;
         height: fit-content;
         display: block;
         border-radius: 15px;
         padding: 10px;
         clear: both;
      }

      .ext-message {
         background-color: #DBDBDB;
         color: black;
         float: left;

      }

      .own-message {
         background-color: #00C533;
         color: white;
         float: right;
      }
   </style>

   <header>
      <form>
         <label>Nickname: </label>
         <input disabled id="nicknameInput" type="text" name="nickname" />
         <select id="nicknameColor" name="color">
            <option value="red" selected>Red</option>
            <option value="green">Green</option>
            <option value="blue">Blue</option>
            <option value="black">Black</option>
         </select>
         <button id="createProfileButton">Create Profile</button>
         <br>
         <button disabled id="joinGame">Join Game</button>
      </form>
   </header>

   <section class="container-chat" id="chatMessages">

   </section>

   <input type="text" id="message" name="message" /><button id="send" disabled>SEND</button>

   <script type="text/javascript">

      let DEBUG = true;

      let messagesDiv = document.getElementById("chatMessages");
      let createProfileButton = document.getElementById('createProfileButton');
      let nicknameInput = document.getElementById('nicknameInput');
      let nicknameColor = document.getElementById('nicknameColor');

      let sendBtn = document.getElementById('send');
      let joinGame = document.getElementById('joinGame');
      let user = { nickname: "", color: "", lastmsg: "", room: "general" };

      function WebSocketChat() {
         user.nickname = prompt("Select your nickname");
         nicknameInput.value = user.nickname;
         if ("WebSocket" in window) {
            if (DEBUG) console.log("WebSocket is supported by your Browser!");
            const socket = io();

            createProfileButton.onclick = (event) => {
               event.preventDefault();
               user.color = nicknameColor.value;
               sendBtn.disabled = false;
               joinGame.disabled = false;
               createProfileButton.disabled = true;

               socket.emit('join', user);
            }

            sendBtn.onclick = function () {
               let inputMessage = document.getElementById('message');
               user.lastmsg = inputMessage.value;
               console.log(user);
               socket.emit('newMessage', user);
            };

            joinGame.onclick = function (event) {
               event.preventDefault();
               console.log("joining", user);
               socket.emit('join game', user);
            };

            socket.on('connect', () => {
               socket.emit('hello', `${user.nickname} connected to the chat`);
            });
            socket.on('join', (data) => {
               console.log('join', data);
               let msg = `
                  <p style="clear: both; text-align: center;">${data.nickname} joined the room</p>
               `
               let parser = new DOMParser();
               let element = parser.parseFromString(msg, "text/html");

               messagesDiv.appendChild(element.getElementsByTagName('p')[0]);
            });
            socket.on('joined player', (data) => {
               let msg = `
                  <p style="clear: both; text-align: center;">${data.players[0]} joined your game</p>
               `

               user.room = data.id;

               let parser = new DOMParser();
               let element = parser.parseFromString(msg, "text/html");

               messagesDiv.appendChild(element.getElementsByTagName('p')[0]);
            });
            socket.on('chat message', (data) => {
               console.log('Message recibido', data);
               let isOwner = user.nickname == data.nickname;

               let msg = `
               <div class="container-message">
                  <span class="message-author" style="color: ${data.color}; float: ${isOwner ? 'right' : 'left'};" >${data.nickname}:</span>
                  <div class="${isOwner ? 'message  own-message' : 'message  ext-message'}">
                     <span>${data.lastmsg}</span>
                  </div>
               </div>
               `

               let parser = new DOMParser();
               let element = parser.parseFromString(msg, "text/html");

               messagesDiv.appendChild(element.getElementsByTagName('div')[0]);
            });

         } else {

            // The browser doesn't support WebSocket
            alert("WebSocket NOT supported by your Browser!");
         }
      }

   </script>
   <script>
      WebSocketChat();
   </script>
</body>

</html>